<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Hello,Pegasus! | Semitia-Blog</title><meta name="keywords" content="Pegasus,嵌入式开发,物联网开发"><meta name="author" content="Semitia"><meta name="copyright" content="Semitia"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Taurus &amp; PegasusTaurus &amp; Pegasus AI计算机视觉基础开发套件组装指导视频 海思社区 (hisilicon.com) 官方教程 官网老是进不去，这是gitee上的pdf 训练服务器获取文档 华为开发者学堂-HarmonyOS物联网开发课程 (huawei.com) 硬件资料&#x2F;HiSpark_WiFi_IoT智能家居开发套件_原理图.rar Hi3861">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello,Pegasus!">
<meta property="og:url" content="http://example.com/2023/05/18/Hello-Pegasus/index.html">
<meta property="og:site_name" content="Semitia-Blog">
<meta property="og:description" content="Taurus &amp; PegasusTaurus &amp; Pegasus AI计算机视觉基础开发套件组装指导视频 海思社区 (hisilicon.com) 官方教程 官网老是进不去，这是gitee上的pdf 训练服务器获取文档 华为开发者学堂-HarmonyOS物联网开发课程 (huawei.com) 硬件资料&#x2F;HiSpark_WiFi_IoT智能家居开发套件_原理图.rar Hi3861">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2023/05/18/ldSIw4gvqzfDRan.jpg">
<meta property="article:published_time" content="2023-05-18T15:17:28.000Z">
<meta property="article:modified_time" content="2023-05-18T15:37:10.694Z">
<meta property="article:author" content="Semitia">
<meta property="article:tag" content="Pegasus">
<meta property="article:tag" content="嵌入式开发">
<meta property="article:tag" content="物联网开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/05/18/ldSIw4gvqzfDRan.jpg"><link rel="shortcut icon" href="https://s2.loli.net/2023/01/11/pS5Y6BHULMA7fND.png"><link rel="canonical" href="http://example.com/2023/05/18/Hello-Pegasus/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: Semitia","link":"Link: ","source":"Source: Semitia-Blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Hello,Pegasus!',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-18 23:37:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-clock/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/11/23/jDFVCRh5mfpWzdT.gif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">39</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/05/18/ldSIw4gvqzfDRan.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Semitia-Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Hello,Pegasus!</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-05-18T15:17:28.000Z" title="Created 2023-05-18 23:17:28">2023-05-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-05-18T15:37:10.694Z" title="Updated 2023-05-18 23:37:10">2023-05-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">12.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>46min</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="Hello,Pegasus!"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Taurus-amp-Pegasus"><a href="#Taurus-amp-Pegasus" class="headerlink" title="Taurus &amp; Pegasus"></a>Taurus &amp; Pegasus</h1><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av425214737/?vd_source=0f383e93e945bca07eaef9a9ee5d9db3">Taurus &amp; Pegasus AI计算机视觉基础开发套件组装指导视频</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.hisilicon.com/forum/all">海思社区 (hisilicon.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.hisilicon.com/postDetail?tid=0206112326723530001">官方教程</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/HiSpark/HiSpark_NICU2023/blob/master/Taurus%20&amp;%20Pegasus%20AI%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E5%9F%BA%E7%A1%80%E5%BC%80%E5%8F%91%E5%A5%97%E4%BB%B6%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99.pdf">官网老是进不去，这是gitee上的pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.hisilicon.com/postDetail?tid=0238117167085302003">训练服务器获取文档</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/training/course/mooc/C101641968823265204?refresh=1669428623989">华为开发者学堂-HarmonyOS物联网开发课程 (huawei.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/hihope_iot/embedded-race-hisilicon-track-2022/blob/master/%E7%A1%AC%E4%BB%B6%E8%B5%84%E6%96%99/HiSpark_WiFi_IoT%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85%E5%BC%80%E5%8F%91%E5%A5%97%E4%BB%B6_%E5%8E%9F%E7%90%86%E5%9B%BE.rar">硬件资料/HiSpark_WiFi_IoT智能家居开发套件_原理图.rar</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/hihope_iot/embedded-race-hisilicon-track-2022/raw/master/%E8%8A%AF%E7%89%87%E8%B5%84%E6%96%99/Hi3861V100%EF%BC%8FHi3861LV100%20AT%E5%91%BD%E4%BB%A4%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97.pdf">Hi3861LV100 AT命令 使用指南.pdf</a></p>
<h1 id="lt-零-gt-Pegasus环境配置与文件架构"><a href="#lt-零-gt-Pegasus环境配置与文件架构" class="headerlink" title="&lt;零&gt; Pegasus环境配置与文件架构"></a>&lt;零&gt; Pegasus环境配置与文件架构</h1><p>跟着官方教程走，到了<strong>build</strong>步骤的时候出现报错</p>
<p><img src="https://s2.loli.net/2023/05/18/4JW8kgfoKsdvtUA.png" alt="零2.png"></p>
<p>或者是这样的</p>
<p><img src="https://s2.loli.net/2023/05/18/wQvckH82I5GWqYX.png" alt="零0.png"></p>
<p>这个问题教程里也有讲过：<strong>尽量将工程文件夹放在根目录下；</strong>实际上应该是：<strong>一定要将工程文件夹放在根目录下</strong></p>
<p>之后就可以成功编译了</p>
<p><img src="https://s2.loli.net/2023/05/18/Sy6Unm2oTzQNrt5.png" alt="零1.png"></p>
<h2 id="Build-gn文件"><a href="#Build-gn文件" class="headerlink" title="Build.gn文件"></a>Build.gn文件</h2><p>BUILD.gn是一种用于描述软件构建信息的文件，它是GN（Generate Ninja）构建系统的一部分12。它的作用是：</p>
<ul>
<li>定义要编译的源文件、头文件路径、编译方式等。</li>
<li>声明目标的依赖关系，如静态库、共享库、可执行文件等。</li>
<li>将设置放在config中，如编译器标志、预处理器定义、包含目录等。</li>
<li>生成Ninja构建文件，用于实际编译和链接代码。</li>
</ul>
<p>BUILD.gn文件通常位于每个源码目录下，以及根目录下。官方demo的 <strong>app</strong> 文件夹下是要烧录到板子之中的代码，通过该目录下的 <strong>BUILD.gn</strong> 文件选择具体使用的 <strong>库</strong> 以及 <strong>源代码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入一个名为lite_component的模板，用于定义OpenHarmony应用组件</span></span><br><span class="line"><span class="keyword">import</span>(<span class="string">&quot;//build/lite/config/component/lite_component.gni&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用lite_component模板定义一个名为app的应用组件</span></span><br><span class="line">lite_component(<span class="string">&quot;app&quot;</span>) &#123;</span><br><span class="line">  <span class="comment"># 指定要依赖的其他目标列表，这里依赖了netDemo静态库目标</span></span><br><span class="line">	<span class="comment"># [子文件夹名:子文件夹下声明的静态库]</span></span><br><span class="line">  features = [ <span class="string">&quot;lwip_demo:netDemo&quot;</span>, ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <strong>app</strong> 文件夹下有存放着各种源码的子文件夹，上面这个例子就应该有着类似 <strong>lwip_demo</strong> 的子文件夹，在这里面存放着<strong>源码</strong>与自己的 <strong>BUILD.gn</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个静态库目标，名为netDemo</span></span><br><span class="line">static_library(<span class="string">&quot;netDemo&quot;</span>) &#123;</span><br><span class="line">  <span class="comment"># 指定要编译的源文件列表</span></span><br><span class="line">  sources = [ <span class="string">&quot;lwip_tcp_server.c&quot;</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 追加更多的源文件到列表中</span></span><br><span class="line">  sources += [</span><br><span class="line">    <span class="string">&quot;demo_entry_cmsis.c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wifi_connecter.c&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 指定要包含的头文件目录列表</span></span><br><span class="line">  include_dirs = [</span><br><span class="line">    <span class="string">&quot;//utils/native/lite/include&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//kernel/liteos_m/components/cmsis/2.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//base/iot_hardware/interfaces/kits/wifiiot_lite&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//base/iot_hardware/peripheral/interfaces/kits&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//foundation/communication/wifi_lite/interfaces/wifiservice&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>sources</code>和<code>sources+</code>添加的源文件没有本质的区别，都是指定要编译的源文件列表。只是为了方便阅读和维护，可以使用+号来追加文件，而不是一次性写出所有的文件。这样可以按照功能或模块来分组文件，也可以避免一行过长的问题，；例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定要编译的源文件列表</span></span><br><span class="line">sources = [ <span class="string">&quot;lwip_tcp_server.c&quot;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 追加来自demo_entry_cmsis目录的源文件</span></span><br><span class="line">sources += [ <span class="string">&quot;demo_entry_cmsis/*.c&quot;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 追加来自wifi_connecter目录的源文件</span></span><br><span class="line">sources += [ <span class="string">&quot;wifi_connecter/*.c&quot;</span> ]</span><br></pre></td></tr></table></figure>
<h1 id="lt-一-gt-hello-world"><a href="#lt-一-gt-hello-world" class="headerlink" title="&lt;一&gt; hello world"></a>&lt;一&gt; hello world</h1><h2 id="修改BUILD-gn来选择需要编译的工程文件"><a href="#修改BUILD-gn来选择需要编译的工程文件" class="headerlink" title="修改BUILD.gn来选择需要编译的工程文件"></a>修改<strong>BUILD.gn</strong>来选择需要编译的工程文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">import(&quot;//build/lite/config/component/lite_component.gni&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lite_component(&quot;app&quot;)</span> &#123;</span><br><span class="line">    <span class="string">features</span> <span class="string">=</span> [</span><br><span class="line">        <span class="string">&quot;hello_world_demo:helloWorld&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>hello_world_demo</strong>：指的是需要编译的工程目录对应的文件夹名</p>
<p><strong>helloWorld</strong>：指的是需要编译的代码中的BUILD.gn的静态库，名称为helloWorld；比如这里就是 <code>./hello_world_demo/BUILD.gn</code> 中声明的库名</p>
<h2 id="修改usr-config-mk文件来配置外设驱动"><a href="#修改usr-config-mk文件来配置外设驱动" class="headerlink" title="修改usr_config.mk文件来配置外设驱动"></a>修改usr_config.mk文件来配置外设驱动</h2><p><code>src/device/hisilicon/hispark_pegasus/sdk_liteos/build/config/usr_config.mk</code></p>
<h1 id="lt-二-gt-Operating-System"><a href="#lt-二-gt-Operating-System" class="headerlink" title="&lt;二&gt; Operating System"></a>&lt;二&gt; Operating System</h1><h2 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h2><p>源码见仓库 <em>Hello_Pegasus</em> 中的 <em>Thread_demo/thread.c</em></p>
<p>入口函数为 <strong>ThreadTestTask</strong> 创建了 <strong>rtosv2_thread_main</strong> 线程。在 <strong>rtosv2_thread_main</strong> 中创建了 <strong>threadTest</strong> 线程，<strong>threadTest</strong> 在<code>while</code>中不断打印； <strong>rtosv2_thread_main</strong> 没有<code>while</code>循环，从头到尾走一遍，调了几个API示例就没了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief Creates an active thread.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* The priority ranges from 9 to 38. Select a proper priority as required.</span></span><br><span class="line"><span class="comment">* The maximum of tasks is LOSCFG_BASE_CORE_TSK_LIMIT(LOSCFG_BASE_CORE_TSK_LIMIT is defined in the traget_config.h).</span></span><br><span class="line"><span class="comment">* @param func Indicates the entry of the thread callback function.线程函数</span></span><br><span class="line"><span class="comment">* @param argument Indicates the pointer to the argument passed to the thread.开始参数</span></span><br><span class="line"><span class="comment">* @param attr Indicates the thread attributes.线程属性</span></span><br><span class="line"><span class="comment">* @return Returns the thread ID; returns NULL in the case of an error.</span></span><br><span class="line"><span class="comment">* @since 1.0</span></span><br><span class="line"><span class="comment">* @version 1.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">osThreadId_t <span class="title function_">osThreadNew</span> <span class="params">(osThreadFunc_t func, <span class="type">void</span> *argument, <span class="type">const</span> osThreadAttr_t *attr)</span>;</span><br></pre></td></tr></table></figure>
<p>常用API</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>接口名称</th>
<th>函数说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>osThreadGetName</td>
<td>获取指定线程的名字</td>
</tr>
<tr>
<td>osThreadGetId</td>
<td>获取当前运行线程的线程ID</td>
</tr>
<tr>
<td>osThreadGetState</td>
<td>获取当前线程的状态</td>
</tr>
<tr>
<td>osThreadSetPriority</td>
<td>设置指定线程的优先级</td>
</tr>
<tr>
<td>osThreadGetPriority</td>
<td>获取当前线程的优先级</td>
</tr>
<tr>
<td>osThreadYield</td>
<td>将运行控制转交给下一个处于READY状态的线程</td>
</tr>
<tr>
<td>osThreadSuspend</td>
<td>挂起指定线程的运行</td>
</tr>
<tr>
<td>osThreadResume</td>
<td>恢复指定线程的运行</td>
</tr>
<tr>
<td>osThreadDetach</td>
<td>分离指定的线程（当线程终止运行时，线程存储可以被回收）</td>
</tr>
<tr>
<td>osThreadJoin</td>
<td>等待指定线程终止运行</td>
</tr>
<tr>
<td>osThreadExit</td>
<td>终止当前线程的运行</td>
</tr>
<tr>
<td>osThreadTerminate</td>
<td>终止指定线程的运行</td>
</tr>
<tr>
<td>osThreadGetStackSize</td>
<td>获取指定线程的栈空间大小</td>
</tr>
<tr>
<td>osThreadGetStackSpace</td>
<td>获取指定线程的未使用的栈空间大小</td>
</tr>
<tr>
<td>osThreadGetCount</td>
<td>获取活跃线程数</td>
</tr>
<tr>
<td>osThreadEnumerate</td>
<td>获取线程组中的活跃线程数</td>
</tr>
</tbody>
</table>
</div>
<h2 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h2><p>创建函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief Creates and initializes a timer.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* This function creates a timer associated with the arguments callback function. The timer stays in the stopped state until OSTimerStart is used to start the timer.</span></span><br><span class="line"><span class="comment">* The timer precision is 1000 / LOSCFG_BASE_CORE_TICK_PER_SECOND ms(LOSCFG_BASE_CORE_TICK_PER_SECOND is defined in the traget_config.h).</span></span><br><span class="line"><span class="comment">* @param func Indicates the entry of the timer callback function.</span></span><br><span class="line"><span class="comment">* @param type Indicates the timer type.</span></span><br><span class="line"><span class="comment">* @param argument Indicates the pointer to the argument used in timer callback.</span></span><br><span class="line"><span class="comment">* @param attr Indicates the pointer to the timer attributes. This parameter is not used.</span></span><br><span class="line"><span class="comment">* @return Returns the timer ID; returns NULL in the case of an error.</span></span><br><span class="line"><span class="comment">* @since 1.0</span></span><br><span class="line"><span class="comment">* @version 1.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">osTimerId_t <span class="title function_">osTimerNew</span> <span class="params">(osTimerFunc_t func, osTimerType_t type, <span class="type">void</span> *argument, <span class="type">const</span> osTimerAttr_t *attr)</span>;</span><br></pre></td></tr></table></figure>
<p>常用API</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>API名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>osTimerNew</td>
<td>创建和初始化定时器</td>
</tr>
<tr>
<td>osTimerGetName</td>
<td>获取指定的定时器名字</td>
</tr>
<tr>
<td>osTimerStart</td>
<td>启动或者重启指定的定时器</td>
</tr>
<tr>
<td>osTimerStop</td>
<td>停止指定的定时器</td>
</tr>
<tr>
<td>osTimerIsRunning</td>
<td>检查一个定时器是否在运行</td>
</tr>
<tr>
<td>osTimerDelete</td>
<td>删除定时器</td>
</tr>
</tbody>
</table>
</div>
<h2 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a><strong>互斥锁</strong></h2><p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/379849079">什么是临界资源，临界区？ - 知乎 (zhihu.com)</a></p>
<p>互斥锁（Mutex）是一种用来保证多个线程或进程之间对共享资源的互斥访问的同步机制。只有一个线程或进程可以获得互斥锁，这意味着互斥锁有所有权的概念，只有拥有互斥锁的线程或进程才能释放它1。<br>互斥锁可以用来实现临界区（Critical Section），即一段只能被一个线程或进程执行的代码。一个线程或进程在进入临界区之前，必须先请求获得互斥锁，如果互斥锁已经被占用，那么该线程或进程就会阻塞等待，直到互斥锁被释放。一个线程或进程在离开临界区之后，必须释放互斥锁，以便其他线程或进程可以进入临界区2。<br>互斥锁有两种类型：本地互斥锁和命名系统互斥锁。如果你使用一个接受名字的构造函数来创建一个互斥锁对象，它就会与操作系统中同名的对象关联。命名系统互斥锁在操作系统中是可见的，可以用来同步不同进程的活动。你可以创建多个代表同一个命名系统互斥锁的对象，也可以使用OpenExisting方法来打开一个已存在的命名系统互斥锁。本地互斥锁只存在于你的进程中。它可以被你的进程中任何拥有该本地互斥锁对象引用的线程使用。每个互斥锁对象都是一个单独的本地互斥锁3。</p>
<blockquote>
<p>哲学家就餐问题1：这是一个经典的并发编程问题，有五个哲学家围坐在一张圆桌旁，每两个哲学家之间有一只叉子，每个哲学家要么思考要么吃饭，吃饭时需要同时拿起左右两只叉子。如果使用互斥锁来保护每只叉子，那么可能出现死锁的情况，即每个哲学家都拿起了左边的叉子，然后等待右边的叉子，导致无法进餐。一种解决方案是让每个哲学家按照编号顺序拿起叉子，即先拿编号较小的叉子，再拿编号较大的叉子，这样可以避免环路等待的条件。<br>丈夫与妻子模型：这是一个简单的信号量问题，有一个丈夫和一个妻子共享一个洗手间，洗手间只能容纳一个人。如果使用互斥锁来保护洗手间，那么可以实现互斥访问，即只有一个人可以进入洗手间，另一个人必须等待。当一个人用完洗手间后，必须释放互斥锁，以便另一个人可以进入。</p>
</blockquote>
<p>死锁是指两个或多个进程互相等待对方占用的资源而无法继续执行的状态。死锁的产生必须满足四个条件：互斥、请求和保持、不剥夺、环路等待。要避免死锁，可以破坏这四个条件中的任何一个。一个通俗的例子是：有两把钥匙和两扇门，每把钥匙只能打开一扇门。如果两个人分别拿了一把钥匙，但是都想打开另一扇门，就会形成死锁1。<br>饥饿是指一个进程因为无法获得所需的资源而长时间等待的现象。饥饿可能是由于资源分配不公平、优先级调度不合理、进程阻塞等原因导致的。一个通俗的例子是：有一个餐厅只有一个服务员，他总是优先服务点菜最多的客人，而忽略了点菜少的客人。这样就会导致点菜少的客人饿肚子。<br>忙等是指一个进程在等待某个条件成立时，不断地检查该条件是否成立，而不释放处理器或让出CPU给其他进程的行为。忙等会浪费CPU资源和时间片，降低系统效率。一个通俗的例子是：有一个人在等待电梯到达自己的楼层时，不断地按电梯按钮，而不去做其他事情。<br>信号量是一种用于实现进程间同步和互斥的机制。信号量是一个整数变量，可以通过P操作（减一）和V操作（加一）来修改。当信号量为零时，P操作会阻塞等待，直到信号量变为正数。当信号量为正数时，V操作会唤醒等待的进程。通过初始化信号量为1或0，可以实现互斥锁或条件变量的功能。一个通俗的例子是：有一个公共厕所只有一个坑位，有多个人想要上厕所。可以设置一个信号量为1，表示坑位是否空闲。每个人在上厕所前要执行P操作，如果坑位空闲就占用坑位并将信号量减为0；如果坑位占用就等待信号量变为1。每个人在上完厕所后要执行V操作，释放坑位并将信号量加为123。</p>
<p>创建函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">**<span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief Creates and initializes a mutex.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param attr Indicates the pointer to the mutex attributes. This parameter is not used.</span></span><br><span class="line"><span class="comment">* @return Returns the mutex ID; returns NULL in the case of an error.</span></span><br><span class="line"><span class="comment">* @since 1.0</span></span><br><span class="line"><span class="comment">* @version 1.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">osMutexId_t <span class="title function_">osMutexNew</span> <span class="params">(<span class="type">const</span> osMutexAttr_t *attr)</span>;**</span><br></pre></td></tr></table></figure>
<p>常用API</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>osMutexGetName</th>
<th>获得指定互斥锁的名字</th>
</tr>
</thead>
<tbody>
<tr>
<td>osMutexAcquire</td>
<td>获得指定的互斥锁的访问权限，若互斥锁已经被锁，则返回超时</td>
</tr>
<tr>
<td>osMutexRelease</td>
<td>释放指定的互斥锁</td>
</tr>
<tr>
<td>osMutexGetOwner</td>
<td>获得指定互斥锁的所有者线程</td>
</tr>
<tr>
<td>osMutexDelete</td>
<td>删除指定的互斥锁</td>
</tr>
</tbody>
</table>
</div>
<h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><p>关于信号量的基本知识这篇文章写得很清楚</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43914272/article/details/108317212">(42条消息) 操作系统——信号量（理解什么是信号量，信号量如何解决同步互斥问题，信号量一些注意点）_五斤w的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43914272/category_10332365.html">(42条消息) 操作系统_五斤w的博客-CSDN博客</a></p>
<p>创建函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief Creates and initializes a semaphore object.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param max_count 最大令牌数，Indicates the maximum number of available tokens that can be applied for.</span></span><br><span class="line"><span class="comment">* @param initial_count 初始令牌数，Indicates the initial number of available tokens.</span></span><br><span class="line"><span class="comment">* @param attr Indicates the pointer to the semaphore attributes. This parameter is not used.</span></span><br><span class="line"><span class="comment">* @return Returns the semaphore ID; returns NULL in the case of an error.</span></span><br><span class="line"><span class="comment">* @since 1.0</span></span><br><span class="line"><span class="comment">* @version 1.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">osSemaphoreId_t <span class="title function_">osSemaphoreNew</span> <span class="params">(<span class="type">uint32_t</span> max_count, <span class="type">uint32_t</span> initial_count, <span class="type">const</span> osSemaphoreAttr_t *attr)</span>;</span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>API名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>osSemaphoreNew</td>
<td>创建并初始化一个信号量</td>
</tr>
<tr>
<td>osSemaphoreGetName</td>
<td>获取一个信号量的名字</td>
</tr>
<tr>
<td>osSemaphoreAcquire</td>
<td>获取一个信号量的令牌，若获取不到，则会超时返回</td>
</tr>
<tr>
<td>osSemaphoreRelease</td>
<td>释放一个信号量的令牌，但是令牌的数量不超过初始定义的的令牌数</td>
</tr>
<tr>
<td>osSemaphoreGetCount</td>
<td>获取当前的信号量令牌数</td>
</tr>
<tr>
<td>osSemaphoreDelete</td>
<td>删除一个信号量</td>
</tr>
</tbody>
</table>
</div>
<p><strong>例程</strong></p>
<p>典型的生产者-消费者问题，其中有一个共享的缓冲区，生产者线程向缓冲区中放入产品，消费者线程从缓冲区中取出产品。为了避免缓冲区溢出或者空闲，需要用两个信号量来控制缓冲区的状态。</p>
<p>empty信号量表示缓冲区中空闲的位置的数量，它的初始值是BUFFER_SIZE，表示一开始缓冲区是空的。当生产者线程想要向缓冲区中放入一个产品时，它需要先获取一个empty信号量的令牌，如果empty信号量有剩余的令牌，说明缓冲区还有空闲的位置，那么生产者线程就可以获取一个令牌并继续执行，如果empty信号量没有剩余的令牌，说明缓冲区已经满了，那么生产者线程就需要等待直到有消费者线程释放令牌或者超时返回。当生产者线程向缓冲区中放入一个产品后，它需要释放一个filled信号量的令牌，表示缓冲区中有一个产品可以被消费。</p>
<p>filled信号量表示缓冲区中已经放入的产品的数量，它的初始值是0，表示一开始缓冲区是没有产品的。当消费者线程想要从缓冲区中取出一个产品时，它需要先获取一个filled信号量的令牌，如果filled信号量有剩余的令牌，说明缓冲区还有产品可以被消费，那么消费者线程就可以获取一个令牌并继续执行，如果filled信号量没有剩余的令牌，说明缓冲区已经空了，那么消费者线程就需要等待直到有生产者线程释放令牌或者超时返回。当消费者线程从缓冲区中取出一个产品后，它需要释放一个empty信号量的令牌，表示缓冲区中有一个空闲的位置可以被填充。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">producer_thread</span><span class="params">(<span class="type">int</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    (<span class="type">int</span>)arg;</span><br><span class="line">    empty_id = osSemaphoreNew(BUFFER_SIZE, BUFFER_SIZE, <span class="literal">NULL</span>);</span><br><span class="line">    filled_id = osSemaphoreNew(BUFFER_SIZE, <span class="number">0U</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        osSemaphoreAcquire(empty_id, osWaitForever);</span><br><span class="line">        product_number++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[Semp Test]%s produces a product, now product number: %d.\r\n&quot;</span>,</span><br><span class="line">            osThreadGetName(osThreadGetId()), product_number);</span><br><span class="line">        osDelay(OS_DELAY);</span><br><span class="line">        osSemaphoreRelease(filled_id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">consumer_thread</span><span class="params">(<span class="type">int</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    (<span class="type">int</span>)arg;</span><br><span class="line">    <span class="keyword">while</span> (NUM) &#123;</span><br><span class="line">        osSemaphoreAcquire(filled_id, osWaitForever);</span><br><span class="line">        product_number--;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[Semp Test]%s consumes a product, now product number: %d.\r\n&quot;</span>,</span><br><span class="line">            osThreadGetName(osThreadGetId()), product_number);</span><br><span class="line">        osDelay(OS_DELAY_S);</span><br><span class="line">        osSemaphoreRelease(empty_id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结起来就是生产者<code>productor</code>根据<strong>空闲位置<code>empty_id</code></strong>获取继续生产的资格</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">osSemaphoreAcquire(empty_id, osWaitForever);</span><br></pre></td></tr></table></figure>
<p>只能使<strong>空闲位置</strong><code>empty_id</code><strong>减少</strong>，使<strong>产品数量</strong><code>filled_id</code>增加</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">osSemaphoreRelease(filled_id);</span><br></pre></td></tr></table></figure>
<p>消费者<code>consumer</code>根据<strong>产品数量</strong><code>filled_id</code>获取消费资格</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">osSemaphoreAcquire(filled_id, osWaitForever);</span><br></pre></td></tr></table></figure>
<p>只能使<strong>产品数量</strong><code>filled_id</code><strong>减少</strong>，使<strong>空闲位置</strong><code>empty_id</code>增加</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">osSemaphoreRelease(empty_id);</span><br></pre></td></tr></table></figure>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><div class="table-container">
<table>
<thead>
<tr>
<th>API名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>osMessageQueueNew</td>
<td>创建和初始化一个消息队列</td>
</tr>
<tr>
<td>osMessageQueueGetName</td>
<td>返回指定的消息队列的名字</td>
</tr>
<tr>
<td>osMessageQueuePut</td>
<td>向指定的消息队列存放1条消息，如果消息队列满了，那么返回超时</td>
</tr>
<tr>
<td>osMessageQueueGet</td>
<td>从指定的消息队列中取得1条消息，如果消息队列为空，那么返回超时</td>
</tr>
<tr>
<td>osMessageQueueGetCapacity</td>
<td>获得指定的消息队列的消息容量</td>
</tr>
<tr>
<td>osMessageQueueGetMsgSize</td>
<td>获得指定的消息队列中可以存放的最大消息的大小</td>
</tr>
<tr>
<td>osMessageQueueGetCount</td>
<td>获得指定的消息队列中当前的消息数</td>
</tr>
<tr>
<td>osMessageQueueGetSpace</td>
<td>获得指定的消息队列中还可以存放的消息数</td>
</tr>
<tr>
<td>osMessageQueueReset</td>
<td>将指定的消息队列重置为初始状态</td>
</tr>
<tr>
<td>osMessageQueueDelete</td>
<td>删除指定的消息队列</td>
</tr>
</tbody>
</table>
</div>
<p>创建函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief Creates and initializes a message queue.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param msg_count 队列长度：Indicates the number of messages in the message queue.</span></span><br><span class="line"><span class="comment">* @param msg_size 队列消息大小：Indicates the size of messages in the message queue.</span></span><br><span class="line"><span class="comment">* @param attr Indicates the pointer to the message queue attributes. This parameter is not used.</span></span><br><span class="line"><span class="comment">* @return Returns the message queue ID; returns NULL in the case of an error.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">osMessageQueueId_t <span class="title function_">osMessageQueueNew</span> <span class="params">(<span class="type">uint32_t</span> msg_count, <span class="type">uint32_t</span> msg_size, <span class="type">const</span> osMessageQueueAttr_t *attr)</span>;</span><br></pre></td></tr></table></figure>
<p>发送消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief Places a message in a message queue.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param mq_id 消息队列ID：Indicates the message queue ID, which is obtained using osMessageQueueNew.</span></span><br><span class="line"><span class="comment">* @param msg_ptr 消息指针：Indicates the pointer to the buffer for storing the message to be placed in the message queue.</span></span><br><span class="line"><span class="comment">* @param msg_prio 消息优先级（此参数没用）Indicates the priority of the message to be placed in the message queue. This parameter is not used.</span></span><br><span class="line"><span class="comment">* @param timeout Indicates the timeout duration.</span></span><br><span class="line"><span class="comment">								 表示超时时间，如果消息队列已满，函数会等待一段时间，直到有空间可以放入消息或者超时返回。</span></span><br><span class="line"><span class="comment">* @return Returns the CMSIS-RTOS running result.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">osStatus_t <span class="title function_">osMessageQueuePut</span> <span class="params">(osMessageQueueId_t mq_id, <span class="type">const</span> <span class="type">void</span> *msg_ptr, <span class="type">uint8_t</span> msg_prio, <span class="type">uint32_t</span> timeout)</span>;</span><br></pre></td></tr></table></figure>
<p>获取消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief Obtains a message in a message queue.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param mq_id 队列ID：Indicates the message queue ID, which is obtained using osMessageQueueNew.</span></span><br><span class="line"><span class="comment">* @param msg_ptr 存放取得消息的指针：Indicates the pointer to the buffer for storing the message to be retrieved from the message queue.</span></span><br><span class="line"><span class="comment">* @param msg_prio （无用）Indicates the pointer to the buffer for storing the priority of the message to be retrieved from the message queue. This parameter is not used.</span></span><br><span class="line"><span class="comment">* @param timeout Indicates the timeout duration.</span></span><br><span class="line"><span class="comment">* @return Returns the CMSIS-RTOS running result.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">osStatus_t <span class="title function_">osMessageQueueGet</span> <span class="params">(osMessageQueueId_t mq_id, <span class="type">void</span> *msg_ptr, <span class="type">uint8_t</span> *msg_prio, <span class="type">uint32_t</span> timeout)</span>;</span><br></pre></td></tr></table></figure>
<p>可以看出，消息队列是一种先进先出的数据结构，不区分发送者和接收者线程的身份，只按照消息的到达顺序进行存取，即使有多个发布者和接收者线程共用这个消息队列的时候也是如此。如果要指定某个线程的功能，可以在消息的内容中加入标识符或者使用其他的通信机制。</p>
<h1 id="lt-三-gt-基本外设"><a href="#lt-三-gt-基本外设" class="headerlink" title="&lt;三&gt; 基本外设"></a>&lt;三&gt; 基本外设</h1><h2 id="GPIO"><a href="#GPIO" class="headerlink" title="GPIO"></a>GPIO</h2><div class="table-container">
<table>
<thead>
<tr>
<th>API名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>unsigned int GpioInit(void);</td>
<td>GPIO模块初始化</td>
</tr>
<tr>
<td>unsigned int GpioSetDir(WifiIotGpioIdx id, WifiIotGpioDir dir);</td>
<td>设置GPIO引脚方向，id参数用于指定引脚，dir参数用于指定输入或输出</td>
</tr>
<tr>
<td>unsigned int GpioSetOutputVal(WifiIotGpioIdx id, WifiIotGpioValue val);</td>
<td>设置GPIO引脚的输出状态，id参数用于指定引脚，val参数用于指定高电平或低电平</td>
</tr>
<tr>
<td>unsigned int IoSetFunc(WifiIotIoName id, unsigned char val);</td>
<td>设置引脚功能，id参数用于指定引脚，val用于指定引脚功能</td>
</tr>
<tr>
<td>unsigned int GpioDeinit(void);</td>
<td>解除GPIO模块初始化</td>
</tr>
</tbody>
</table>
</div>
<p>每个IO口具体的可以配置的功能可以参考 <strong>iot_gpio_ex.h，</strong>里面有各个IO口的宏定义；通过 <strong>IoSetFunc( )</strong> 配置IO口功能</p>
<h2 id="GPIO中断"><a href="#GPIO中断" class="headerlink" title="GPIO中断"></a>GPIO中断</h2><div class="table-container">
<table>
<thead>
<tr>
<th>API名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>unsigned int GpioGetInputVal(WifiIotGpioIdx id, WifiIotGpioValue *val);</td>
<td>获取GPIO引脚状态，id参数用于指定引脚，val参数用于接收GPIO引脚状态</td>
</tr>
<tr>
<td>unsigned int IoSetPull(WifiIotIoName id, WifiIotIoPull val);</td>
<td>设置引脚上拉或下拉状态，id参数用于指定引脚，val参数用于指定上拉或下拉状态</td>
</tr>
<tr>
<td>unsigned int GpioRegisterIsrFunc(WifiIotGpioIdx id, WifiIotGpioIntType intType, WifiIotGpioIntPolarity intPolarity, GpioIsrCallbackFunc func, char *arg);</td>
<td>注册GPIO引脚中断，id参数用于指定引脚，intType参数用于指定中断触发类型（边缘触发或水平触发），intPolarity参数用于指定具体的边缘类型（下降沿或上升沿）或水平类型（高电平或低电平），func参数用于指定中断处理函数，arg参数用于指定中断处理函数的附加参数</td>
</tr>
<tr>
<td>typedef void (<em>GpioIsrCallbackFunc) (char </em>arg);</td>
<td>中断处理函数原型，arg参数为附加参数，可以不适用（填NULL），或传入指向用户自定义类型的参数</td>
</tr>
<tr>
<td>unsigned int GpioUnregisterIsrFunc(WifiIotGpioIdx id);</td>
<td>解除GPIO引脚中断注册，id参数用于指定引脚</td>
</tr>
</tbody>
</table>
</div>
<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">IoTGpioInit(LED_TEST_GPIO);</span><br><span class="line">IoTGpioSetDir(LED_TEST_GPIO, IOT_GPIO_DIR_OUT);</span><br><span class="line"></span><br><span class="line"><span class="comment">//GPIO5链接按键</span></span><br><span class="line">IoTGpioInit(IOT_GPIO_KEY);</span><br><span class="line">IoSetFunc(IOT_GPIO_KEY, <span class="number">0</span>);<span class="comment">//GPIO模式</span></span><br><span class="line">IoTGpioSetDir(IOT_GPIO_KEY, IOT_GPIO_DIR_IN);<span class="comment">//输入</span></span><br><span class="line">IoSetPull(IOT_GPIO_KEY, IOT_IO_PULL_UP);<span class="comment">//上拉</span></span><br><span class="line">IoTGpioRegisterIsrFunc(IOT_GPIO_KEY, IOT_INT_TYPE_EDGE, IOT_GPIO_EDGE_FALL_LEVEL_LOW, OnButtonPressed, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<p>示例demo实现了通过按键控制<strong>led</strong>在<strong>亮、灭、闪烁</strong>间切换</p>
<h2 id="PWM输出"><a href="#PWM输出" class="headerlink" title="PWM输出"></a>PWM输出</h2><div class="table-container">
<table>
<thead>
<tr>
<th>unsigned int PwmInit(WifiIotPwmPort port);</th>
<th>PWM模块初始化</th>
</tr>
</thead>
<tbody>
<tr>
<td>unsigned int PwmStart(WifiIotPwmPort port, unsigned short duty, unsigned short freq);</td>
<td>开始输出PWM信号</td>
</tr>
<tr>
<td>unsigned int PwmStop(WifiIotPwmPort port);</td>
<td>停止输出PWM信号</td>
</tr>
<tr>
<td>unsigned int PwmDeinit(WifiIotPwmPort port);</td>
<td>解除PWM模块初始化</td>
</tr>
<tr>
<td>unsigned int PwmSetClock(WifiIotPwmClkSource clkSource);</td>
<td>设置PWM模块时钟源</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<h3 id="example-1"><a href="#example-1" class="headerlink" title="example"></a>example</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IOT_PWM_BEEP        9</span></span><br><span class="line">IoTGpioInit(IOT_PWM_BEEP);</span><br><span class="line">IoSetFunc(IOT_PWM_BEEP, <span class="number">5</span>); </span><br><span class="line">IoTGpioSetDir(IOT_PWM_BEEP, IOT_GPIO_DIR_OUT);</span><br><span class="line">IoTPwmInit(IOT_PWM_PORT_PWM0);</span><br><span class="line">IoTPwmStart(IOT_PWM_PORT_PWM0, <span class="number">50</span>, <span class="number">4000</span>); <span class="comment">/* 占空比50 / 4000,频率4000 */</span></span><br><span class="line">IoTPwmStop(IOT_PWM_PORT_PWM0);</span><br></pre></td></tr></table></figure>
<p>具体的IO口及其功能配置可参考<code>iot_gpio_ex.h</code>，这里是将<strong>GPIO9</strong>配置为<strong>5</strong>号功能，即<strong>PWM0_OUT</strong></p>
<h2 id="ADC输入"><a href="#ADC输入" class="headerlink" title="ADC输入"></a>ADC输入</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">AdcRead</span><span class="params">(WifiIotAdcChannelIndex channel, <span class="type">unsigned</span> <span class="type">short</span> *data, WifiIotAdcEquModelSel equModel, WifiIotAdcCurBais curBais, <span class="type">unsigned</span> <span class="type">short</span> rstCnt)</span>;</span><br></pre></td></tr></table></figure>
<p>输入参数是通道<code>channel</code>，存数据的的指针<code>*data</code>，ADC方程模型<code>equModel</code>，参考电压<code>curBais</code>，<code>rstnt</code>表示从复位到转换开始的时间计数，每个计数相当于334纳秒，取值范围是0到0xFF0。</p>
<h3 id="方程模型"><a href="#方程模型" class="headerlink" title="方程模型"></a>方程模型</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    <span class="comment">/** One-equation model */</span></span><br><span class="line">    IOT_ADC_EQU_MODEL_1,</span><br><span class="line">    <span class="comment">/** Two-equation model */</span></span><br><span class="line">    IOT_ADC_EQU_MODEL_2,</span><br><span class="line">    <span class="comment">/** Four-equation model */</span></span><br><span class="line">    IOT_ADC_EQU_MODEL_4,</span><br><span class="line">    <span class="comment">/** Eight-equation model */</span></span><br><span class="line">    IOT_ADC_EQU_MODEL_8,</span><br><span class="line">    <span class="comment">/** Button value */</span></span><br><span class="line">    IOT_ADC_EQU_MODEL_BUTT,</span><br><span class="line">&#125; IotAdcEquModelSel;</span><br></pre></td></tr></table></figure>
<p>方程模型是用来设置ADC的分辨率的，也就是ADC能够区分多少个不同等级的模拟输入电压。分辨率越高，表示ADC能够更精确地转换模拟信号，但也需要更多的时间和资源。方程模型的枚举类型有四个选项，分别对应一元、二元、四元和八元方程模型。一元方程模型是最简单的，它只需要一个方程就能确定ADC的输出值。二元方程模型需要两个方程，四元方程模型需要四个方程，八元方程模型需要八个方程。方程的数量越多，表示ADC的分辨率越高，但也越复杂。</p>
<h3 id="复位rstcnt"><a href="#复位rstcnt" class="headerlink" title="复位rstcnt"></a>复位rstcnt</h3><p>（bing说的，仅供参考）</p>
<p>rstCnt是用来设置从复位到转换开始的时间计数的，也就是ADC在复位后需要等待多久才能开始转换模拟信号。这个参数可以用来调节ADC的采样速率，也就是每秒钟能转换多少次模拟信号。rstCnt的值越大，表示等待的时间越长，采样速率越低。rstCnt的值越小，表示等待的时间越短，采样速率越高。rstCnt的单位是ADC时钟周期，每个周期相当于334纳秒。rstCnt的取值范围是0到0xFF0，也就是0到4080个时钟周期。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://securitycamcenter.com/reset-adc-alarm-com-camera/">ADC可以通过软件或硬件的方式来复位。软件复位是通过设置ADC的控制寄存器来实现的，比如ADC_Reset函数<strong>1</strong></a><a target="_blank" rel="noopener" href="https://support.citrix.com/article/CTX200852/citrix-adc-netscaler-reset-codes-reference">。硬件复位是通过外部信号或电源来实现的，比如ADC_ResetPin函数<strong>2</strong></a>。</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/mrlixirong/article/details/102763721">ADC可以在初始化时进行复位，以清除之前的设置和状态，保证ADC的正常工作。比如在STM32F0xx标准库中，有一个函数叫做ADC_DeInit，它可以把ADC恢复到默认状态<strong>3</strong></a>。</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Redbean33/article/details/109614383">ADC可以在转换前或转换后进行复位，以避免一些错误或干扰。比如在F28335芯片中，有一个函数叫做ADC_reset，它可以在转换前复位整个ADC模块<strong>4</strong></a>。另外，在某些模式下，比如连续转换模式或DMA模式，ADC可能会在转换完成后自动复位。</li>
<li>ADC可以在遇到异常情况时进行复位，以恢复正常工作。比如在Alarm.Com摄像头中，如果出现连接问题或配置问题，可以通过按住复位按钮来恢复出厂设置。</li>
</ul>
<h3 id="参考电压"><a href="#参考电压" class="headerlink" title="参考电压"></a>参考电压</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    <span class="comment">/** Automatic control */</span></span><br><span class="line">    IOT_ADC_CUR_BAIS_DEFAULT,</span><br><span class="line">    <span class="comment">/** Automatic control */</span></span><br><span class="line">    IOT_ADC_CUR_BAIS_AUTO,</span><br><span class="line">    <span class="comment">/** Manual control (AVDD = 1.8 V) */</span></span><br><span class="line">    IOT_ADC_CUR_BAIS_1P8V,</span><br><span class="line">    <span class="comment">/** Manual control (AVDD = 3.3 V) */</span></span><br><span class="line">    IOT_ADC_CUR_BAIS_3P3V,</span><br><span class="line">    <span class="comment">/** Button value */</span></span><br><span class="line">    IOT_ADC_CUR_BAIS_BUTT,</span><br><span class="line">&#125; IotAdcCurBais;</span><br></pre></td></tr></table></figure>
<p>参考电压是用来作为ADC转换的标准的，也就是ADC能够测量的最大输入电压。参考电压越高，表示ADC能够接受更大范围的模拟信号，但也会降低转换的精度。参考电压可以是内部或外部提供的，也可以是自动控制的。模拟电源控制模式是用来设置参考电压的来源和值的。模拟电源控制模式的枚举类型有五个选项，分别对应默认、自动、1.8V、3.3V和按钮值。默认和自动表示由系统自动选择合适的参考电压，1.8V和3.3V表示手动选择固定的参考电压，按钮值表示无效的选项。</p>
<h2 id="I2C通信"><a href="#I2C通信" class="headerlink" title="I2C通信"></a>I2C通信</h2><div class="table-container">
<table>
<thead>
<tr>
<th>API名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>IoTI2cInit(unsigned int id, unsigned int baudrate);</td>
<td>用指定的波特速率初始化I2C设备</td>
</tr>
<tr>
<td>IoTI2cDeinit(unsigned int id);</td>
<td>取消初始化I2C设备</td>
</tr>
<tr>
<td>IoTI2cWrite(unsigned int id, unsigned short deviceAddr, const unsigned char *data, unsigned int dataLen);</td>
<td>将数据写入I2C设备</td>
</tr>
<tr>
<td>IoTI2cRead(unsigned int id, unsigned short deviceAddr, unsigned char *data, unsigned int dataLen);</td>
<td>从I2C设备中读取数据</td>
</tr>
<tr>
<td>IoTI2cSetBaudrate(unsigned int id, unsigned int baudrate);</td>
<td>设置I2C设备的波特率</td>
</tr>
</tbody>
</table>
</div>
<h1 id="lt-四-gt-TCP通讯"><a href="#lt-四-gt-TCP通讯" class="headerlink" title="&lt;四&gt; TCP通讯"></a>&lt;四&gt; TCP通讯</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/400788077">一篇看懂 | TCP原理详细图解 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/64155705">TCP协议详解 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/341011748">socket套接字详解（TCP与UDP） - 知乎 (zhihu.com)</a></p>
<p>例程代码使用了<strong>lwip</strong>库来实现tcp通信的功能。</p>
<blockquote>
<p>lwip是一个轻量级的tcp/ip协议栈，适用于嵌入式系统。</p>
</blockquote>
<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包含标准输入输出库</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// 包含lwip库中的sockets头文件，提供了socket编程的接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lwip/sockets.h&quot;</span></span></span><br><span class="line"><span class="comment">// 包含net_demo头文件，定义了一些函数原型和宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;net_demo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局变量g_request，是一个字符串数组，存放了要发送给服务器的数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> g_request[] = <span class="string">&quot;Hello,I am Lwip&quot;</span>;</span><br><span class="line"><span class="comment">// 定义一个全局变量g_response，是一个字符串数组，存放了从服务器接收到的数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> g_response[<span class="number">128</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个函数TcpClientTest，用于作为客户端与服务器进行tcp通信</span></span><br><span class="line"><span class="comment">// 参数host是服务器的IP地址，参数port是服务器的端口号</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TcpClientTest</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* host, <span class="type">unsigned</span> <span class="type">short</span> port)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 调用socket函数创建一个TCP套接字，返回一个套接字描述符sockfd</span></span><br><span class="line">		<span class="comment">//套接字是网络编程中的一种通信机制，是支持TCP/IP的网络通信的基本操作单元，可以看做是不同主机之间的进程进行双向通信的端点</span></span><br><span class="line">		<span class="comment">//简单的说就是通信的两方的一种约定，用套接字中的相关函数来完成通信过程。</span></span><br><span class="line">    <span class="comment">// 参数AF_INET表示使用IPv4协议族，参数SOCK_STREAM表示使用TCP协议，参数0表示使用默认协议</span></span><br><span class="line">    <span class="type">int</span> sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">// TCP socket</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个结构体变量serverAddr，用于存放服务器的地址信息</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverAddr</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">// 设置地址族为AF_INET，与套接字参数一致</span></span><br><span class="line">    serverAddr.sin_family = AF_INET;  <span class="comment">// AF_INET表示IPv4协议</span></span><br><span class="line">    <span class="comment">// 设置端口号为port，并转换为网络字节序（大端序）</span></span><br><span class="line">		<span class="comment">//主机字节序是指不同的计算机系统存储数据的方式，有大端字节序和小端字节序之分。网络字节序是指TCP/IP协议规定的数据传输的方式，采用大端字节序。</span></span><br><span class="line">    serverAddr.sin_port = htons(port);  <span class="comment">// 端口号，从主机字节序转为网络字节序</span></span><br><span class="line">    <span class="comment">// 调用inet_pton函数将主机IP地址从“点分十进制”字符串转化为标准格式（32位整数），并存放在serverAddr.sin_addr中</span></span><br><span class="line">    <span class="comment">// 如果转换成功则返回正数，如果失败则返回负数或0，并关闭套接字</span></span><br><span class="line">    <span class="keyword">if</span> (inet_pton(AF_INET, host, &amp;serverAddr.sin_addr) &lt;= <span class="number">0</span>) &#123;  <span class="comment">// 将主机IP地址从“点分十进制”字符串 转化为 标准格式（32位整数）</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;inet_pton failed!\r\n&quot;</span>);</span><br><span class="line">        lwip_close(sockfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用connect函数尝试和目标主机建立连接，连接成功会返回0 ，失败返回 -1</span></span><br><span class="line">    <span class="comment">// 参数sockfd是套接字描述符，参数serverAddr是目标主机的地址信息，参数sizeof(serverAddr)是地址信息的长度</span></span><br><span class="line">    <span class="keyword">if</span> (connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;serverAddr, <span class="keyword">sizeof</span>(serverAddr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connect failed!\r\n&quot;</span>);</span><br><span class="line">        lwip_close(sockfd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果连接成功，则打印提示信息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;connect to server %s success!\r\n&quot;</span>, host);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建立连接成功之后，这个TCP套接字描述符sockfd就具有了“连接状态”，发送、接收对端都是connect参数指定的目标主机和端口</span></span><br><span class="line">    <span class="comment">// 调用send函数发送数据给服务器，返回值retval是实际发送的字节数</span></span><br><span class="line">    <span class="comment">// 参数sockfd是套接字描述符，参数g_request是要发送的数据缓冲区，参数sizeof(g_request)是要发送的数据长度，参数0表示使用默认标志</span></span><br><span class="line">    <span class="type">ssize_t</span> retval = send(sockfd, g_request, <span class="keyword">sizeof</span>(g_request), <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 如果返回值小于0，则表示发送失败，并关闭套接字</span></span><br><span class="line">    <span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send g_request failed!\r\n&quot;</span>);</span><br><span class="line">        lwip_close(sockfd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果发送成功，则打印提示信息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;send g_request&#123;%s&#125; %ld to server done!\r\n&quot;</span>, g_request, retval);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用recv函数接收服务器发送过来的数据，并存放在g_response缓冲区中，返回值retval是实际接收到的字节数</span></span><br><span class="line">    <span class="comment">// sockfd是套接字描述符，g_response是要接收的数据缓冲区，sizeof(g_response)是要接收的数据长度，参数0表示使用默认标志</span></span><br><span class="line">    retval = recv(sockfd, &amp;g_response, <span class="keyword">sizeof</span>(g_response), <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 如果返回值小于等于0，则表示接收失败或者完成，并关闭套接字</span></span><br><span class="line">    <span class="keyword">if</span> (retval &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send g_response from server failed or done, %ld!\r\n&quot;</span>, retval);</span><br><span class="line">        lwip_close(sockfd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果接收成功，则在g_response末尾添加一个空字符&#x27;\0&#x27;作为字符串结束符，并打印提示信息</span></span><br><span class="line">    g_response[retval] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv g_response&#123;%s&#125; %ld from server done!\r\n&quot;</span>, g_response, retval);</span><br><span class="line">    <span class="comment">// 关闭套接字</span></span><br><span class="line">    lwip_close(sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个函数NetDemoTest，用于调用TcpClientTest函数进行测试</span></span><br><span class="line"><span class="comment">// 参数port是服务器端口号，参数host是服务器IP地址</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">NetDemoTest</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> port, <span class="type">const</span> <span class="type">char</span>* host)</span></span><br><span class="line">&#123;</span><br><span class="line">    (<span class="type">void</span>) host;</span><br><span class="line">    <span class="comment">// 打印提示信息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TcpClientTest start\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;I will connect to %s\r\n&quot;</span>, host);</span><br><span class="line">    <span class="comment">// 调用TcpClientTest函数进行tcp通信测试</span></span><br><span class="line">    TcpClientTest(host, port);</span><br><span class="line">    <span class="comment">// 打印提示信息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TcpClientTest done!\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接收函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retval = recv(sockfd, &amp;g_response, <span class="keyword">sizeof</span>(g_response), <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>关于接收函数，我问了newbing一些问题，这是它的回答。</p>
<p>如果接收成功的话，retval就是接收到的数据字节数吗？</p>
<p>是的，如果接收成功的话，retval就是接收到的数据长度，单位是字节。recv函数的返回值是一个ssize_t类型的整数，它表示实际接收到的字节数。如果返回值等于0，表示对方已经关闭了连接；如果返回值小于0，表示发生了错误，可以用errno变量来查看错误码。</p>
<p>retval小于零或等于零分别有什么含义吗？</p>
<p>如上所述，retval小于零表示发生了错误，retval等于零表示对方已经关闭了连接。一些常见的错误码有：</p>
<ul>
<li>EAGAIN或EWOULDBLOCK：表示套接字是非阻塞的，而当前没有可用的数据，需要稍后再试。</li>
<li>EBADF：表示套接字描述符无效。</li>
<li>ECONNREFUSED：表示远程主机拒绝了连接请求。</li>
<li>EFAULT：表示缓冲区指针指向无效的内存地址。</li>
<li>EINTR：表示接收过程被信号中断。</li>
<li>EINVAL：表示传递了无效的参数。</li>
<li>ENOMEM：表示内存不足。</li>
<li>ENOTCONN：表示套接字没有连接。</li>
<li>ENOTSOCK：表示套接字描述符不是一个套接字。</li>
<li>ETIMEDOUT：表示连接超时。</li>
</ul>
<p>接收到的数据是被自动接收然后存放在某个缓冲区里吗？如果我不调用这个函数，发送者是否会接收到这个数据的ACK呢？</p>
<p>是的，接收到的数据是被自动接收然后存放在内核为每个套接字维护的一个缓冲区里。recv函数只是从缓冲区中读取数据，并将其复制到用户指定的缓冲区中。如果用户不调用recv函数，那么内核缓冲区可能会被填满，导致TCP流量控制机制生效，使得发送者降低发送速率或停止发送。发送者是否会接收到这个数据的ACK取决于内核缓冲区是否有空间来存放新到达的数据。如果有空间，那么内核会发送ACK给发送者；如果没有空间，那么内核会延迟发送ACK或发送窗口为零的ACK给发送者。</p>
<p>我是否可以将发送和接受分别使用两个线程实现呢？</p>
<p>是的，你可以将发送和接受分别使用两个线程实现。这样可以实现全双工通信，即同时进行发送和接受操作。你需要为每个线程传递相同的套接字描述符，并在每个线程中调用send和recv函数。你还需要注意同步和互斥问题，避免多个线程同时操作同一个资源。</p>
<h1 id="lt-五-gt-MQTT协议"><a href="#lt-五-gt-MQTT协议" class="headerlink" title="&lt;五&gt; MQTT协议"></a>&lt;五&gt; MQTT协议</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/421109780">MQTT协议，终于有人讲清楚了 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/json/json-syntax.html">JSON 语法 | 菜鸟教程 (runoob.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hi_task.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hi_wifi_api.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hi_mux.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hi_io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hi_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iot_config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iot_log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iot_main.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iot_profile.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ohos_init.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cmsis_os2.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* attribute initiative to report */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAKE_THE_INITIATIVE_TO_REPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ONE_SECOND                          (1000)</span></span><br><span class="line"><span class="comment">/* oc request id */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CN_COMMADN_INDEX                    <span class="string">&quot;commands/request_id=&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WECHAT_SUBSCRIBE_LIGHT              <span class="string">&quot;light&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WECHAT_SUBSCRIBE_LIGHT_ON_STATE     <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WECHAT_SUBSCRIBE_LIGHT_OFF_STATE    <span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="comment">// &lt; 全局变量，表示灯的状态，-1表示未初始化，0表示关，1表示开</span></span><br><span class="line"><span class="type">int</span> g_ligthStatus = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt; 这是一个函数指针类型，用于回调函数的参数</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*FnMsgCallBack)</span><span class="params">(hi_gpio_value val)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt; 这是一个结构体类型，用于存储一些功能回调的相关信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FunctionCallback</span> &#123;</span></span><br><span class="line"> hi_bool stop; <span class="comment">// &lt; 是否停止</span></span><br><span class="line"> hi_u32 conLost; <span class="comment">// &lt; 连接丢失次数</span></span><br><span class="line"> hi_u32 queueID; <span class="comment">// &lt; 队列ID</span></span><br><span class="line"> hi_u32 iotTaskID; <span class="comment">// &lt; IoT任务ID</span></span><br><span class="line"> FnMsgCallBack msgCallBack; <span class="comment">// &lt; 消息回调函数指针</span></span><br><span class="line">&#125;FunctionCallback;</span><br><span class="line">FunctionCallback g_functinoCallback; <span class="comment">// &lt; 定义一个全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CPU Sleep time Set */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">TaskMsleep</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> ms)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span> (ms &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> HI_ERR_FAILURE;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> hi_sleep((hi_u32)ms);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt; 这是一个设备配置初始化的函数，用于设置GPIO_9引脚的功能和输出值</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">DeviceConfigInit</span><span class="params">(hi_gpio_value val)</span></span><br><span class="line">&#123;</span><br><span class="line"> hi_io_set_func(HI_IO_NAME_GPIO_9, HI_IO_FUNC_GPIO_9_GPIO); <span class="comment">// &lt; 设置GPIO_9引脚为GPIO功能</span></span><br><span class="line"> hi_gpio_set_dir(HI_GPIO_IDX_9, HI_GPIO_DIR_OUT); <span class="comment">// &lt; 设置GPIO_9引脚为输出方向</span></span><br><span class="line"> hi_gpio_set_ouput_val(HI_GPIO_IDX_9, val); <span class="comment">// &lt; 设置GPIO_9引脚的输出值为val</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt; 这是一个设备消息回调函数的注册函数，用于将回调函数指针赋值给全局变量</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">DeviceMsgCallback</span><span class="params">(FnMsgCallBack msgCallBack)</span></span><br><span class="line">&#123;</span><br><span class="line"> g_functinoCallback.msgCallBack = msgCallBack;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt; 这是一个微信控制设备消息的函数，用于根据val值初始化设备配置</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">wechatControlDeviceMsg</span><span class="params">(hi_gpio_value val)</span></span><br><span class="line">&#123;</span><br><span class="line"> DeviceConfigInit(val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt; 这是一个MQTT消息接收回调函数，当有消息到达时会被调用</span></span><br><span class="line"><span class="comment">// &lt; qos:数据可靠性  topic:订阅主题  payload参数是一个json字符串，包含了设备状态信息</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">DemoMsgRcvCallBack</span><span class="params">(<span class="type">int</span> qos, <span class="type">const</span> <span class="type">char</span> *topic, <span class="type">const</span> <span class="type">char</span> *payload)</span></span><br><span class="line">&#123;</span><br><span class="line"> IOT_LOG_DEBUG(<span class="string">&quot;RCVMSG:QOS:%d TOPIC:%s PAYLOAD:%s\r\n&quot;</span>, qos, topic, payload);</span><br><span class="line"> <span class="comment">/* 云端下发命令后，板端的操作处理 */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">strstr</span>(payload, WECHAT_SUBSCRIBE_LIGHT) != <span class="literal">NULL</span>) &#123; <span class="comment">// &lt; 如果payload中包含了WECHAT_SUBSCRIBE_LIGHT字符串</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">strstr</span>(payload, WECHAT_SUBSCRIBE_LIGHT_OFF_STATE) != <span class="literal">NULL</span>) &#123; <span class="comment">// &lt; 如果payload中包含了WECHAT_SUBSCRIBE_LIGHT_OFF_STATE字符串</span></span><br><span class="line"> wechatControlDeviceMsg(HI_GPIO_VALUE1); <span class="comment">// &lt; 调用微信控制设备消息函数，传入HI_GPIO_VALUE1作为参数</span></span><br><span class="line"> g_ligthStatus = HI_FALSE; <span class="comment">// &lt; 将灯的状态设置为关</span></span><br><span class="line"> &#125; <span class="keyword">else</span> &#123; <span class="comment">// &lt; 否则</span></span><br><span class="line"> wechatControlDeviceMsg(HI_GPIO_VALUE0); <span class="comment">// &lt; 调用微信控制设备消息函数，传入HI_GPIO_VALUE0作为参数</span></span><br><span class="line"> g_ligthStatus = HI_TRUE; <span class="comment">// &lt; 将灯的状态设置为开</span></span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> HI_NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* publish sample */</span></span><br><span class="line">hi_void <span class="title function_">IotPublishSample</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">/* reported attribute */</span></span><br><span class="line"> WeChatProfile weChatProfile = &#123;</span><br><span class="line"> .subscribeType = <span class="string">&quot;type&quot;</span>,<span class="comment">//订阅类型，表示设备的类型，比如温度计、湿度计、电机、灯等。</span></span><br><span class="line"> .status.subState = <span class="string">&quot;state&quot;</span>,<span class="comment">//订阅状态，表示设备是否订阅了云端的服务，比如接收命令或发送数据。</span></span><br><span class="line"> .status.subReport = <span class="string">&quot;reported&quot;</span>,<span class="comment">//订阅报告，表示设备是否向云端报告了自己的属性信息。</span></span><br><span class="line"> .status.reportVersion = <span class="string">&quot;version&quot;</span>,<span class="comment">//表示设备属性信息的版本号，用于区分不同的报告。</span></span><br><span class="line"> .status.Token = <span class="string">&quot;clientToken&quot;</span>,<span class="comment">//客户端令牌，表示设备与云端通信的身份标识，用于验证和授权。</span></span><br><span class="line"> <span class="comment">/* report motor */</span></span><br><span class="line"> .reportAction.subDeviceActionMotor = <span class="string">&quot;motor&quot;</span>,</span><br><span class="line"> .reportAction.motorActionStatus = <span class="number">0</span>, <span class="comment">/* 0 : motor off */</span></span><br><span class="line"> <span class="comment">/* report temperature */</span></span><br><span class="line"> .reportAction.subDeviceActionTemperature = <span class="string">&quot;temperature&quot;</span>,</span><br><span class="line"> .reportAction.temperatureData = <span class="number">30</span>, <span class="comment">/* 30 :temperature data */</span></span><br><span class="line"> <span class="comment">/* report humidity */</span></span><br><span class="line"> .reportAction.subDeviceActionHumidity = <span class="string">&quot;humidity&quot;</span>,</span><br><span class="line"> .reportAction.humidityActionData = <span class="number">70</span>, <span class="comment">/* humidity data */</span></span><br><span class="line"> <span class="comment">/* report light_intensity */</span></span><br><span class="line"> .reportAction.subDeviceActionLightIntensity = <span class="string">&quot;light_intensity&quot;</span>,</span><br><span class="line"> .reportAction.lightIntensityActionData = <span class="number">60</span>, <span class="comment">/* 60 : light_intensity */</span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* report light */</span></span><br><span class="line"> <span class="keyword">if</span> (g_ligthStatus == HI_TRUE) &#123; <span class="comment">// &lt; 如果灯的状态是开</span></span><br><span class="line"> weChatProfile.reportAction.subDeviceActionLight = <span class="string">&quot;light&quot;</span>;</span><br><span class="line"> weChatProfile.reportAction.lightActionStatus = <span class="number">1</span>; <span class="comment">/* 1: light on */</span></span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (g_ligthStatus == HI_FALSE) &#123; <span class="comment">// &lt; 如果灯的状态是关</span></span><br><span class="line"> weChatProfile.reportAction.subDeviceActionLight = <span class="string">&quot;light&quot;</span>;</span><br><span class="line"> weChatProfile.reportAction.lightActionStatus = <span class="number">0</span>; <span class="comment">/* 0: light off */</span></span><br><span class="line"> &#125; <span class="keyword">else</span> &#123; <span class="comment">// &lt; 否则</span></span><br><span class="line"> weChatProfile.reportAction.subDeviceActionLight = <span class="string">&quot;light&quot;</span>;</span><br><span class="line"> weChatProfile.reportAction.lightActionStatus = <span class="number">0</span>; <span class="comment">/* 0: light off */</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* profile report */</span></span><br><span class="line"> IoTProfilePropertyReport(CONFIG_USER_ID, &amp;weChatProfile); <span class="comment">// &lt; 调用IoTProfilePropertyReport函数，传入用户ID和weChatProfile结构体指针作为参数，向云端报告设备属性信息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt; 这是一个示例主任务入口函数，在这里我们会设置wifi/cjson/mqtt准备好并等待有任何工作要做的while循环中</span></span><br><span class="line"><span class="type">static</span> hi_void *<span class="title function_">DemoEntry</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"> WifiStaReadyWait(); <span class="comment">// &lt; 等待wifi连接成功</span></span><br><span class="line"> cJsonInit(); <span class="comment">// &lt; 初始化cjson库</span></span><br><span class="line"> IoTMain(); <span class="comment">// &lt; 调用IoTMain函数，初始化MQTT客户端并连接到服务器</span></span><br><span class="line"> <span class="comment">/* 云端下发回调 */</span></span><br><span class="line"> IoTSetMsgCallback(DemoMsgRcvCallBack); <span class="comment">// &lt; 调用IoTSetMsgCallback函数，将DemoMsgRcvCallBack函数指针作为参数传入，设置MQTT消息接收回调函数</span></span><br><span class="line"> <span class="comment">/* 主动上报 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TAKE_THE_INITIATIVE_TO_REPORT </span></span><br><span class="line"> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"> <span class="comment">/* 用户可以在这调用发布函数进行发布，需要用户自己写调用函数 */</span></span><br><span class="line"> IotPublishSample(); <span class="comment">// 发布例程 </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line"> TaskMsleep(ONE_SECOND); </span><br><span class="line"> &#125; </span><br><span class="line"> <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt; 这是一个示例入口函数，在这里我们创建了一个任务，</span></span><br><span class="line"><span class="comment">// 所有的工作都在demo_entry中完成了 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CN_IOT_TASK_STACKSIZE 0x1000 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CN_IOT_TASK_PRIOR 25 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CN_IOT_TASK_NAME <span class="string">&quot;IOTDEMO&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">AppDemoIot</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> osThreadAttr_t attr;</span><br><span class="line"> IoTWatchDogDisable();</span><br><span class="line"></span><br><span class="line"> attr.name = <span class="string">&quot;IOTDEMO&quot;</span>;</span><br><span class="line"> attr.attr_bits = <span class="number">0U</span>;</span><br><span class="line"> attr.cb_mem = <span class="literal">NULL</span>;</span><br><span class="line"> attr.cb_size = <span class="number">0U</span>;</span><br><span class="line"> attr.stack_mem = <span class="literal">NULL</span>;</span><br><span class="line"> attr.stack_size = CN_IOT_TASK_STACKSIZE;</span><br><span class="line"> attr.priority = CN_IOT_TASK_PRIOR;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (osThreadNew((osThreadFunc_t)DemoEntry, <span class="literal">NULL</span>, &amp;attr) == <span class="literal">NULL</span>) &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;[mqtt] Falied to create IOTDEMO!\n&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYS_RUN(AppDemoIot);</span><br></pre></td></tr></table></figure>
<h2 id="发送函数"><a href="#发送函数" class="headerlink" title="发送函数"></a>发送函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CN_PROFILE_TOPICFMT_TOPIC            <span class="string">&quot;$shadow/operation/19VUBHD786/mqtt&quot;</span></span></span><br><span class="line"><span class="comment">//向微信小程序发送设备的属性信息。</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">IoTProfilePropertyReport</span><span class="params">(<span class="type">char</span> *deviceID, WeChatProfile *payload)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line"> <span class="type">char</span> *topic;</span><br><span class="line"> <span class="type">char</span> *msg;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 函数有两个参数：deviceID和payload。</span></span><br><span class="line"> <span class="comment">// deviceID是一个字符串，表示设备的唯一标识符；</span></span><br><span class="line"> <span class="comment">// payload是一个WeChatProfile类型的指针，表示设备的属性信息。</span></span><br><span class="line"> <span class="keyword">if</span> ((deviceID == <span class="literal">NULL</span>) || (payload== <span class="literal">NULL</span>)) &#123;</span><br><span class="line"> <span class="keyword">return</span> ret;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 函数内部定义了三个局部变量：ret，topic和msg。</span></span><br><span class="line"> <span class="comment">// ret是一个整数，用于存储发送结果；</span></span><br><span class="line"> <span class="comment">// topic是一个字符串指针，用于存储发送的主题；</span></span><br><span class="line"> <span class="comment">// msg是一个字符串指针，用于存储发送的消息。</span></span><br><span class="line"> topic = MakeTopic(CN_PROFILE_TOPICFMT_TOPIC, deviceID, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="comment">// 调用MakeTopic函数，根据CN_PROFILE_TOPICFMT_TOPIC和deviceID生成一个主题，并赋值给topic。</span></span><br><span class="line"> <span class="comment">// CN_PROFILE_TOPICFMT_TOPIC是一个宏定义，表示主题的格式；</span></span><br><span class="line"> <span class="comment">// MakeTopic函数是一个自定义函数，用于拼接字符串。</span></span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="literal">NULL</span>) &#123;</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> msg = MakeProfileReport(payload);</span><br><span class="line"> <span class="comment">// 调用MakeProfileReport函数，根据payload生成一个消息，并赋值给msg。</span></span><br><span class="line"> <span class="comment">// MakeProfileReport函数是一个自定义函数，用于将WeChatProfile类型的结构体转换为JSON格式的字符串。</span></span><br><span class="line"> <span class="keyword">if</span> ((topic != <span class="literal">NULL</span>) &amp;&amp; (msg != <span class="literal">NULL</span>)) &#123;</span><br><span class="line"> ret = IotSendMsg(<span class="number">0</span>, topic, msg);</span><br><span class="line"> <span class="comment">// 如果topic和msg都不为空，则调用IotSendMsg函数，向微信小程序发送消息，并将返回值赋给ret。</span></span><br><span class="line"> <span class="comment">// IotSendMsg函数是一个自定义函数，用于通过MQTT协议发送消息。</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> hi_free(<span class="number">0</span>, topic);</span><br><span class="line"> cJSON_free(msg);</span><br><span class="line"> <span class="comment">// 释放topic和msg占用的内存。</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> ret;</span><br><span class="line"> <span class="comment">// 函数返回一个整数，表示发送结果。如果成功，返回0；如果失败，返回-1。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="lt-六-gt-MQTT通讯实验"><a href="#lt-六-gt-MQTT通讯实验" class="headerlink" title="&lt;六&gt; MQTT通讯实验"></a>&lt;六&gt; MQTT通讯实验</h1><h2 id="小程序环境配置"><a href="#小程序环境配置" class="headerlink" title="小程序环境配置"></a>小程序环境配置</h2><p>跟着教程走，在<strong>cloudfunctions</strong>选择环境之前会新建一个云环境，但是选择的时候却没有这个选项。关闭工程重新打开即可刷新。</p>
<h2 id="工程源码阅读"><a href="#工程源码阅读" class="headerlink" title="工程源码阅读"></a>工程源码阅读</h2><p>首先看工程配置。souce中的多个<strong>c文件</strong>被编译为静态库供父级使用；在父级的BUILD文件中调用<strong>app_demo_iot</strong>，故其为app层入口。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// iottencent_demo/BUILD.gn</span><br><span class="line">static_library(<span class="string">&quot;appDemoIot&quot;</span>) &#123;</span><br><span class="line">  sources = [</span><br><span class="line">    <span class="string">&quot;app_demo_iot.c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cjson_init.c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;iot_hmac.c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;iot_log.c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;iot_main.c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;iot_profile.c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;iot_sta.c&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  include_dirs = [</span><br><span class="line">    <span class="string">&quot;./&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//utils/native/lite/include&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//kernel/liteos_m/kal/cmsis&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//base/iot_hardware/peripheral/interfaces/kits&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//device/hisilicon/hispark_pegasus/sdk_liteos/third_party/lwip_sack/include/lwip&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//third_party/cJSON&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//device/hisilicon/hispark_pegasus/sdk_liteos/third_party/mbedtls/include/mbedtls&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//foundation/communication/wifi_lite/interfaces/wifiservice&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//device/hisilicon/hispark_pegasus/sdk_liteos/third_party/paho.mqtt.c/include/mqtt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//device/hisilicon/hispark_pegasus/sdk_liteos/third_party/libcoap/include/coap2&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  defines = [ <span class="string">&quot;WITH_LWIP&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="iot-profile"><a href="#iot-profile" class="headerlink" title="iot_profile"></a>iot_profile</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CN_PROFILE_TOPICFMT_TOPIC            <span class="string">&quot;$shadow/operation/Pegasus/Board1&quot;</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>$shadow</code></strong>表示设备影子的主题前缀，设备影子是一种用于存储和同步设备状态的机制。</li>
<li><strong><code>/operation</code></strong>表示操作类型的主题分隔符，操作类型包括获取、更新、删除等。</li>
<li><strong><code>/Pegasus/Board1</code></strong>表示设备的标识符，用于区分不同的设备。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个函数，用于上报物联网设备的配置信息，其实就是将wechatprofile转化为话题消息并发送</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">IoTProfilePropertyReport</span><span class="params">(<span class="type">char</span> *deviceID, WeChatProfile *payload)</span>&#123;</span><br><span class="line">  <span class="type">int</span> ret = <span class="number">-1</span>; <span class="comment">//定义一个变量，表示返回值，默认为-1，表示失败</span></span><br><span class="line">  <span class="type">char</span> *topic; <span class="comment">//定义一个变量，表示主题字符串</span></span><br><span class="line">  <span class="type">char</span> *msg; <span class="comment">//定义一个变量，表示消息字符串</span></span><br><span class="line">  <span class="keyword">if</span> ((deviceID == <span class="literal">NULL</span>) || (payload== <span class="literal">NULL</span>)) &#123; <span class="comment">//如果参数为空</span></span><br><span class="line">    <span class="keyword">return</span> ret; <span class="comment">//返回-1，表示失败</span></span><br><span class="line">  &#125;</span><br><span class="line">  topic = MakeTopic(CN_PROFILE_TOPICFMT_TOPIC, deviceID, <span class="literal">NULL</span>); <span class="comment">//调用MakeTopic()函数，根据设备ID和一个固定的主题格式，生成一个主题字符串，并赋值给topic变量</span></span><br><span class="line">  <span class="keyword">if</span> (topic == <span class="literal">NULL</span>) &#123; <span class="comment">//如果主题字符串为空</span></span><br><span class="line">    <span class="keyword">return</span> ret; <span class="comment">//返回-1，表示失败</span></span><br><span class="line">  &#125;</span><br><span class="line">  msg = MakeProfileReport(payload); <span class="comment">//调用MakeProfileReport()函数，根据设备的配置信息结构体，生成一个JSON格式的消息字符串，并赋值给msg变量</span></span><br><span class="line">  <span class="keyword">if</span> ((topic != <span class="literal">NULL</span>) &amp;&amp; (msg != <span class="literal">NULL</span>)) &#123; <span class="comment">//如果主题字符串和消息字符串都不为空</span></span><br><span class="line">    ret = IotSendMsg(<span class="number">0</span>, topic, msg); <span class="comment">//调用IotSendMsg()函数，将消息发送到主题，并将返回值赋值给ret变量</span></span><br><span class="line">  &#125;</span><br><span class="line">  hi_free(<span class="number">0</span>, topic); <span class="comment">//释放主题字符串占用的内存</span></span><br><span class="line">  cJSON_free(msg); <span class="comment">//释放消息字符串占用的内存</span></span><br><span class="line">  <span class="keyword">return</span> ret; <span class="comment">//返回ret变量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通信数据格式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个结构体类型，表示设备影子的状态信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *subState; <span class="comment">//表示订阅状态，有sub和unsub两种取值</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *subReport; <span class="comment">//表示上报状态，有report和unreport两种取值</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *reportVersion; <span class="comment">//表示上报版本，用于同步设备影子的版本</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *Token; <span class="comment">//表示令牌，用于验证设备身份</span></span><br><span class="line">&#125;WeChatProfileStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个结构体类型，表示设备的上报信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> lightActionStatus; <span class="comment">//表示灯的动作状态，有0和1两种取值，分别表示关和开</span></span><br><span class="line">  <span class="type">int</span> motorActionStatus; <span class="comment">//表示电机的动作状态，有0和1两种取值，分别表示停止和运行</span></span><br><span class="line">  <span class="type">int</span> temperatureData; <span class="comment">//表示温度数据，单位是摄氏度</span></span><br><span class="line">  <span class="type">int</span> humidityActionData; <span class="comment">//表示湿度数据，单位是百分比</span></span><br><span class="line">  <span class="type">int</span> lightIntensityActionData; <span class="comment">//表示光照强度数据，单位是勒克斯</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *subDeviceActionLight; <span class="comment">//表示灯的动作指令，有on和off两种取值，分别表示开和关</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *subDeviceActionMotor; <span class="comment">//表示电机的动作指令，有start和stop两种取值，分别表示运行和停止</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *subDeviceActionTemperature; <span class="comment">//表示温度的动作指令，有get和set两种取值，分别表示获取和设置</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *subDeviceActionHumidity; <span class="comment">//表示湿度的动作指令，有get和set两种取值，分别表示获取和设置</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *subDeviceActionLightIntensity; <span class="comment">//表示光照强度的动作指令，有get和set两种取值，分别表示获取和设置</span></span><br><span class="line">&#125;WeChatProfileReporte;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个结构体类型，表示设备影子的完整信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *subscribeType; <span class="comment">//表示订阅类型，有status、report、all三种取值，分别表示订阅状态、上报、全部</span></span><br><span class="line">  WeChatProfileStatus status; <span class="comment">//表示设备影子的状态信息结构体</span></span><br><span class="line">  WeChatProfileReporte reportAction; <span class="comment">//表示设备的上报信息结构体</span></span><br><span class="line">&#125;WeChatProfile;</span><br></pre></td></tr></table></figure>
<h3 id="app-demo-iot-c"><a href="#app-demo-iot-c" class="headerlink" title="app_demo_iot.c"></a>app_demo_iot.c</h3><p>主函数创建了一个线程，注册消息接收回调函数，并且可以不断发送消息汇报当前状态。</p>
<p>回调函数解析数据，并依此控制led亮灭。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">IoTSetMsgCallback(DemoMsgRcvCallBack);<span class="comment">//回调函数的注册</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">DemoMsgRcvCallBack</span><span class="params">(<span class="type">int</span> qos, <span class="type">const</span> <span class="type">char</span> *topic, <span class="type">const</span> <span class="type">char</span> *payload)</span></span><br><span class="line">&#123;</span><br><span class="line">    IOT_LOG_DEBUG(<span class="string">&quot;RCVMSG:QOS:%d TOPIC:%s PAYLOAD:%s\r\n&quot;</span>, qos, topic, payload);</span><br><span class="line">    <span class="comment">/* 云端下发命令后，板端的操作处理 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(payload, WECHAT_SUBSCRIBE_LIGHT) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(payload, WECHAT_SUBSCRIBE_LIGHT_OFF_STATE) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            wechatControlDeviceMsg(HI_GPIO_VALUE1);</span><br><span class="line">            g_ligthStatus = HI_FALSE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wechatControlDeviceMsg(HI_GPIO_VALUE0);</span><br><span class="line">            g_ligthStatus = HI_TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HI_NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>strstr()</code> 函数搜索一个字符串在另一个字符串中的第一次出现。</p>
<ul>
<li>找到所搜索的字符串，则该函数返回第一次匹配的字符串的地址；</li>
<li>如果未找到所搜索的字符串，则返回NULL。</li>
</ul>
<p>需要注意的是收到消息后第一时间触发的回调函数并不是这个函数，查看DEBUG信息可知</p>
<blockquote>
<p>[DEBUG][MsgRcvCallBack] RCVMSG:QOS:0 TOPIC:GNJOUT1LQ6/Board1/data PAYLOAD:{“light”:0}</p>
<p>[DEBUG][ProcessQueueMsg] QUEUEMSG:QOS:0 TOPIC:GNJOUT1LQ6/Board1/data PAYLOAD:{“light”:0}</p>
<p>[DEBUG][DemoMsgRcvCallBack] RCVMSG:QOS:0 TOPIC:GNJOUT1LQ6/Board1/data PAYLOAD:{“light”:0}</p>
</blockquote>
<p>系统先通过<code>MsgRcvCallBack()</code>和<code>ProcessQueueMsg()</code>处理后，再将信息给到我们<strong>自己定义</strong>的回调函数中</p>
<h3 id="iot-main"><a href="#iot-main" class="headerlink" title="iot_main"></a>iot_main</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个枚举类型，表示消息的类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  EN_IOT_MSG_PUBLISH = <span class="number">0</span>, <span class="comment">//发布消息</span></span><br><span class="line">  EN_IOT_MSG_RECV, <span class="comment">//接收消息</span></span><br><span class="line">&#125;EnIotMsg;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个结构体类型，表示消息的内容</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  EnIotMsg type; <span class="comment">//消息的类型</span></span><br><span class="line">  <span class="type">int</span> qos; <span class="comment">//消息的服务质量</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *topic; <span class="comment">//消息的主题</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *payload; <span class="comment">//消息的有效载荷</span></span><br><span class="line">&#125;IoTMsg_t;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个结构体类型，表示应用程序的回调信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">bool</span> stop; <span class="comment">//是否停止运行</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> conLost; <span class="comment">//连接丢失的次数</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> queueID; <span class="comment">//消息队列的ID</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> iotTaskID; <span class="comment">//物联网任务的ID</span></span><br><span class="line">  fnMsgCallBack msgCallBack; <span class="comment">//消息回调函数的指针</span></span><br><span class="line">  MQTTClient_deliveryToken tocken; <span class="comment">//发布消息的令牌</span></span><br><span class="line">&#125;IotAppCb_t;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明一个全局变量，存储应用程序的回调信息</span></span><br><span class="line"><span class="type">static</span> IotAppCb_t gIoTAppCb;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief Obtains a message in a message queue.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param mq_id Indicates the message queue ID, which is obtained using osMessageQueueNew.</span></span><br><span class="line"><span class="comment">* @param msg_ptr Indicates the pointer to the buffer for storing the message to be retrieved from the message queue.</span></span><br><span class="line"><span class="comment">* @param msg_prio Indicates the pointer to the buffer for storing the priority of the message to be retrieved from the message queue. This parameter is not used.</span></span><br><span class="line"><span class="comment">* @param timeout Indicates the timeout duration.</span></span><br><span class="line"><span class="comment">* @return Returns the CMSIS-RTOS running result.</span></span><br><span class="line"><span class="comment">* @since 1.0</span></span><br><span class="line"><span class="comment">* @version 1.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">osStatus_t <span class="title function_">osMessageQueueGet</span> <span class="params">(osMessageQueueId_t mq_id, <span class="type">void</span> *msg_ptr, <span class="type">uint8_t</span> *msg_prio, <span class="type">uint32_t</span> timeout)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * When you want to send some messages to the iot server(including the response message),</span></span><br><span class="line"><span class="comment"> * please call this api</span></span><br><span class="line"><span class="comment"> * @param qos: the mqtt qos,:0,1,2</span></span><br><span class="line"><span class="comment"> * @param topic: the iot mqtt topic</span></span><br><span class="line"><span class="comment"> * @param payload: the mqtt payload</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return 0 success while others failed</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @instruction: if success means we write the message to the queue susccess,</span></span><br><span class="line"><span class="comment"> * not means communicate with the server success</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">IotSendMsg</span><span class="params">(<span class="type">int</span> qos, <span class="type">const</span> <span class="type">char</span> *topic, <span class="type">const</span> <span class="type">char</span> *payload)</span>;</span><br></pre></td></tr></table></figure>
<p>接收到信息的“底层”回调函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CN_TOPIC_SUBSCRIBE_NUM     (sizeof(gDefaultSubscribeTopic) / sizeof(const char *))</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">MsgRcvCallBack</span><span class="params">(<span class="type">char</span> *context, <span class="type">char</span> *topic, <span class="type">int</span> topicLen, MQTTClient_message *message)</span></span><br><span class="line">&#123;</span><br><span class="line">    IoTMsg_t  *msg;</span><br><span class="line">    <span class="type">char</span> *buf;</span><br><span class="line">    <span class="type">unsigned</span>  <span class="type">int</span> bufSize;</span><br><span class="line">    <span class="type">int</span> topiLen = topicLen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (topiLen == <span class="number">0</span>) &#123;</span><br><span class="line">        topiLen = <span class="built_in">strlen</span>(topic);</span><br><span class="line">    &#125;</span><br><span class="line">    bufSize = topiLen + <span class="number">1</span>  + message-&gt;payloadlen + <span class="number">1</span> + <span class="keyword">sizeof</span>(IoTMsg_t);</span><br><span class="line">    buf = hi_malloc(<span class="number">0</span>, bufSize);</span><br><span class="line">    <span class="keyword">if</span> (buf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        msg = (IoTMsg_t *)buf;</span><br><span class="line">        buf += <span class="keyword">sizeof</span>(IoTMsg_t);</span><br><span class="line">        bufSize -= <span class="keyword">sizeof</span>(IoTMsg_t);</span><br><span class="line">        msg-&gt;qos = message-&gt;qos;</span><br><span class="line">        msg-&gt;type = EN_IOT_MSG_RECV;</span><br><span class="line">        (<span class="type">void</span>)memcpy_s(buf, bufSize, topic, topiLen);</span><br><span class="line">        buf[topiLen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        msg-&gt;topic = buf;</span><br><span class="line">        buf += topiLen + <span class="number">1</span>;</span><br><span class="line">        bufSize -= (topiLen + <span class="number">1</span>);</span><br><span class="line">        (<span class="type">void</span>)memcpy_s(buf, bufSize, message-&gt;payload, message-&gt;payloadlen);</span><br><span class="line">        buf[message-&gt;payloadlen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        msg-&gt;payload = buf;</span><br><span class="line">        IOT_LOG_DEBUG(<span class="string">&quot;RCVMSG:QOS:%d TOPIC:%s PAYLOAD:%s\r\n&quot;</span>, msg-&gt;qos, msg-&gt;topic, msg-&gt;payload);</span><br><span class="line">        <span class="keyword">if</span> (IOT_SUCCESS != osMessageQueuePut(gIoTAppCb.queueID, &amp;msg, <span class="number">0</span>, CN_QUEUE_WAITTIMEOUT)) &#123;</span><br><span class="line">            IOT_LOG_ERROR(<span class="string">&quot;Wrie queue failed\r\n&quot;</span>);</span><br><span class="line">            hi_free(<span class="number">0</span>, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MQTTClient_freeMessage(&amp;message);</span><br><span class="line">    MQTTClient_free(topic);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个函数，用于处理消息队列中的消息</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">MqttProcessQueueMsg</span><span class="params">(MQTTClient client, IoTMsg_t *msg, MQTTClient_message pubMsg)</span>&#123;</span><br><span class="line">  <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> (msg-&gt;type) &#123; <span class="comment">//根据消息的类型执行不同的操作</span></span><br><span class="line">    <span class="keyword">case</span> EN_IOT_MSG_PUBLISH: <span class="comment">//如果消息类型是发布消息</span></span><br><span class="line">      pubMsg.payload = (<span class="type">void</span> *)msg-&gt;payload; <span class="comment">//将消息的有效载荷赋值给发布消息结构体</span></span><br><span class="line">      pubMsg.payloadlen = (<span class="type">int</span>)<span class="built_in">strlen</span>(msg-&gt;payload); <span class="comment">//将消息的长度赋值给发布消息结构体</span></span><br><span class="line">      pubMsg.qos = msg-&gt;qos; <span class="comment">//将消息的服务质量赋值给发布消息结构体</span></span><br><span class="line">      pubMsg.retained = <span class="number">0</span>; <span class="comment">//将消息的保留标志赋值给发布消息结构体</span></span><br><span class="line">      ret = MQTTClient_publishMessage(client, msg-&gt;topic, &amp;pubMsg, &amp;gIoTAppCb.tocken); <span class="comment">//调用MQTT客户端对象的发布消息方法，将消息发送到指定的主题</span></span><br><span class="line">      <span class="keyword">if</span> (ret != MQTTCLIENT_SUCCESS) &#123; <span class="comment">//如果发送失败</span></span><br><span class="line">        IOT_LOG_ERROR(<span class="string">&quot;MSGSEND:failed\r\n&quot;</span>); <span class="comment">//打印错误日志</span></span><br><span class="line">      &#125;</span><br><span class="line">      IOT_LOG_DEBUG(<span class="string">&quot;MSGSEND:SUCCESS\r\n&quot;</span>); <span class="comment">//打印调试日志</span></span><br><span class="line">      gIoTAppCb.tocken++; <span class="comment">//将令牌加一</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> EN_IOT_MSG_RECV: <span class="comment">//如果消息类型是接收消息</span></span><br><span class="line">      <span class="keyword">if</span> (gIoTAppCb.msgCallBack != <span class="literal">NULL</span>) &#123; <span class="comment">//如果应用程序回调信息中有消息回调函数的指针</span></span><br><span class="line">        gIoTAppCb.msgCallBack(msg-&gt;qos, msg-&gt;topic, msg-&gt;payload); <span class="comment">//调用该函数，并将消息的服务质量、主题和有效载荷作为参数传递</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="comment">//如果消息类型是其他值</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;use this function to deal all the comming message</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ProcessQueueMsg</span><span class="params">(MQTTClient client)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span>  <span class="type">int</span>     ret;</span><br><span class="line">    <span class="type">unsigned</span>  <span class="type">int</span>     msgSize;</span><br><span class="line">    IoTMsg_t  *msg;</span><br><span class="line">    <span class="type">unsigned</span>  <span class="type">int</span>     timeout;</span><br><span class="line">    MQTTClient_message pubmsg = MQTTClient_message_initializer;</span><br><span class="line"></span><br><span class="line">    timeout = CN_QUEUE_WAITTIMEOUT;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        msg = <span class="literal">NULL</span>;</span><br><span class="line">        msgSize = <span class="keyword">sizeof</span>(hi_pvoid);</span><br><span class="line">        ret = osMessageQueueGet(gIoTAppCb.queueID, &amp;msg, &amp;msgSize, timeout);</span><br><span class="line">        <span class="keyword">if</span> (msg != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            IOT_LOG_DEBUG(<span class="string">&quot;QUEUEMSG:QOS:%d TOPIC:%s PAYLOAD:%s\r\n&quot;</span>, msg-&gt;qos, msg-&gt;topic, msg-&gt;payload);</span><br><span class="line">            MqttProcessQueueMsg(client, msg, pubmsg);</span><br><span class="line">            hi_free(<span class="number">0</span>, msg);</span><br><span class="line">        &#125;</span><br><span class="line">        timeout = <span class="number">0</span>;  <span class="comment">// &lt; continous to deal the message without wait here</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (ret == IOT_SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h3><p>理论上来说板子会根据云端信息控制灯的亮灭，但实际上云端只能接受信息更新状态，并不能控制板子（会提示发布失败）</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">Semitia</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/18/Hello-Pegasus/">http://example.com/2023/05/18/Hello-Pegasus/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Pegasus/">Pegasus</a><a class="post-meta__tags" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/">嵌入式开发</a><a class="post-meta__tags" href="/tags/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91/">物联网开发</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/05/18/ldSIw4gvqzfDRan.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/18/hello-C51/"><img class="prev-cover" src="https://s2.loli.net/2023/05/18/5s13gyZMrGmFa6K.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">hello,C51!</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/23/camera-imu%E8%81%94%E5%90%88%E6%A0%87%E5%AE%9A/"><img class="next-cover" src="https://s2.loli.net/2022/10/22/1cmKWnzpGHvxsEh.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">camera-imu联合标定</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/05/19/WeChat-App-Notes/" title="WeChat App Development Notes"><img class="cover" src="https://s2.loli.net/2023/05/19/zHWONf7puaMklPZ.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-19</div><div class="title">WeChat App Development Notes</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/11/23/jDFVCRh5mfpWzdT.gif" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Semitia</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">39</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Semitia"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Semitia" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:3272979503@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Welcome to my tiny blog 😁<div class="twopeople"><div class="twopeople"><div class="container"style="height:200px;"><canvas class="illo"width="800"height="800"style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div><script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople1.js"></script><script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/zdog.dist.js"></script><script id="rendered-js"src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople.js"></script><style>.twopeople{margin:0;align-items:center;justify-content:center;text-align:center}canvas{display:block;margin:0 auto;cursor:move}</style></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Taurus-amp-Pegasus"><span class="toc-number">1.</span> <span class="toc-text">Taurus &amp; Pegasus</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lt-%E9%9B%B6-gt-Pegasus%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%96%87%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">&lt;零&gt; Pegasus环境配置与文件架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Build-gn%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">Build.gn文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lt-%E4%B8%80-gt-hello-world"><span class="toc-number">3.</span> <span class="toc-text">&lt;一&gt; hello world</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9BUILD-gn%E6%9D%A5%E9%80%89%E6%8B%A9%E9%9C%80%E8%A6%81%E7%BC%96%E8%AF%91%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.</span> <span class="toc-text">修改BUILD.gn来选择需要编译的工程文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9usr-config-mk%E6%96%87%E4%BB%B6%E6%9D%A5%E9%85%8D%E7%BD%AE%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8"><span class="toc-number">3.2.</span> <span class="toc-text">修改usr_config.mk文件来配置外设驱动</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lt-%E4%BA%8C-gt-Operating-System"><span class="toc-number">4.</span> <span class="toc-text">&lt;二&gt; Operating System</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Thread"><span class="toc-number">4.1.</span> <span class="toc-text">Thread</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Timer"><span class="toc-number">4.2.</span> <span class="toc-text">Timer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">4.3.</span> <span class="toc-text">互斥锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">4.3.1.</span> <span class="toc-text">信号量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">4.3.2.</span> <span class="toc-text">消息队列</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lt-%E4%B8%89-gt-%E5%9F%BA%E6%9C%AC%E5%A4%96%E8%AE%BE"><span class="toc-number">5.</span> <span class="toc-text">&lt;三&gt; 基本外设</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GPIO"><span class="toc-number">5.1.</span> <span class="toc-text">GPIO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GPIO%E4%B8%AD%E6%96%AD"><span class="toc-number">5.2.</span> <span class="toc-text">GPIO中断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#example"><span class="toc-number">5.2.1.</span> <span class="toc-text">example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWM%E8%BE%93%E5%87%BA"><span class="toc-number">5.3.</span> <span class="toc-text">PWM输出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#example-1"><span class="toc-number">5.3.1.</span> <span class="toc-text">example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ADC%E8%BE%93%E5%85%A5"><span class="toc-number">5.4.</span> <span class="toc-text">ADC输入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.4.1.</span> <span class="toc-text">方程模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E4%BD%8Drstcnt"><span class="toc-number">5.4.2.</span> <span class="toc-text">复位rstcnt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E7%94%B5%E5%8E%8B"><span class="toc-number">5.4.3.</span> <span class="toc-text">参考电压</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I2C%E9%80%9A%E4%BF%A1"><span class="toc-number">5.5.</span> <span class="toc-text">I2C通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lt-%E5%9B%9B-gt-TCP%E9%80%9A%E8%AE%AF"><span class="toc-number">6.</span> <span class="toc-text">&lt;四&gt; TCP通讯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#client"><span class="toc-number">6.0.1.</span> <span class="toc-text">client</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lt-%E4%BA%94-gt-MQTT%E5%8D%8F%E8%AE%AE"><span class="toc-number">7.</span> <span class="toc-text">&lt;五&gt; MQTT协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E5%87%BD%E6%95%B0"><span class="toc-number">7.1.</span> <span class="toc-text">发送函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lt-%E5%85%AD-gt-MQTT%E9%80%9A%E8%AE%AF%E5%AE%9E%E9%AA%8C"><span class="toc-number">8.</span> <span class="toc-text">&lt;六&gt; MQTT通讯实验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">8.1.</span> <span class="toc-text">小程序环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="toc-number">8.2.</span> <span class="toc-text">工程源码阅读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#iot-profile"><span class="toc-number">8.2.1.</span> <span class="toc-text">iot_profile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app-demo-iot-c"><span class="toc-number">8.2.2.</span> <span class="toc-text">app_demo_iot.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iot-main"><span class="toc-number">8.2.3.</span> <span class="toc-text">iot_main</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98"><span class="toc-number">8.2.4.</span> <span class="toc-text">遇到问题</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/27/%E7%AE%80%E6%98%93%E7%A4%BA%E6%B3%A2%E5%99%A8/" title="简易示波器"><img src="https://s2.loli.net/2023/10/27/iZhTX9LGW1pRQAb.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="简易示波器"/></a><div class="content"><a class="title" href="/2023/10/27/%E7%AE%80%E6%98%93%E7%A4%BA%E6%B3%A2%E5%99%A8/" title="简易示波器">简易示波器</a><time datetime="2023-10-27T13:50:21.000Z" title="Created 2023-10-27 21:50:21">2023-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/25/Balance_Infantry/" title="Balance_Infantry 仿真"><img src="https://s2.loli.net/2022/10/22/vNqFRVgunTHQS5t.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Balance_Infantry 仿真"/></a><div class="content"><a class="title" href="/2023/10/25/Balance_Infantry/" title="Balance_Infantry 仿真">Balance_Infantry 仿真</a><time datetime="2023-10-25T14:52:13.000Z" title="Created 2023-10-25 22:52:13">2023-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/09/Infantry/" title="Infantry 代码重构"><img src="https://s2.loli.net/2023/10/27/N2uMTngCBValsSc.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Infantry 代码重构"/></a><div class="content"><a class="title" href="/2023/10/09/Infantry/" title="Infantry 代码重构">Infantry 代码重构</a><time datetime="2023-10-09T09:07:35.000Z" title="Created 2023-10-09 17:07:35">2023-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/19/WeChat-App-Notes/" title="WeChat App Development Notes"><img src="https://s2.loli.net/2023/05/19/zHWONf7puaMklPZ.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WeChat App Development Notes"/></a><div class="content"><a class="title" href="/2023/05/19/WeChat-App-Notes/" title="WeChat App Development Notes">WeChat App Development Notes</a><time datetime="2023-05-19T15:17:41.000Z" title="Created 2023-05-19 23:17:41">2023-05-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/18/scattered-Python-scripts/" title="scattered Python scripts"><img src="https://s2.loli.net/2023/05/18/XMRrewnHfbT9J45.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="scattered Python scripts"/></a><div class="content"><a class="title" href="/2023/05/18/scattered-Python-scripts/" title="scattered Python scripts">scattered Python scripts</a><time datetime="2023-05-18T15:47:27.000Z" title="Created 2023-05-18 23:47:27">2023-05-18</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Semitia</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 5000);</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.semitia.top/',
      region: 'ap-shanghai',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.semitia.top/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="cheat.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://npm.elemecdn.com/hexo-butterfly-clock/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://npm.elemecdn.com/hexo-butterfly-clock/lib/clock.min.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>